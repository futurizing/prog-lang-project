!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.ProgLangCompiler=e.ProgLangCompiler||{})}(this,function(e){"use strict";var t,r=function(){function e(e){this.sourceCode=e,this.lineStartPos=[0];for(var t=-1;;){if(t=this.getNextNewlinePosition(t+1),t===-1)break;this.lineStartPos.push(t)}}return e.prototype.getNextNewlinePosition=function(e){var t=this.sourceCode.indexOf("\r",e);return t!==-1?t:(t=this.sourceCode.indexOf("\n",e),t!==-1?t:(t=this.sourceCode.indexOf("\r\n",e),t!==-1?t:-1))},e.prototype.getLineAndCol=function(e){for(var t=0;t<this.lineStartPos.length;t++)if(e<this.lineStartPos[t])return{line:t,col:e-this.lineStartPos[t-1]};return{line:this.lineStartPos.length,col:e-this.lineStartPos[this.lineStartPos.length-1]}},e}();!function(e){e[e.Plus=0]="Plus",e[e.And=1]="And",e[e.As=2]="As",e[e.BooleanValueFalse=3]="BooleanValueFalse",e[e.BooleanValueTrue=4]="BooleanValueTrue",e[e.ButIf=5]="ButIf",e[e.By=6]="By",e[e.FunctionCall=7]="FunctionCall",e[e.Comma=8]="Comma",e[e.Decrease=9]="Decrease",e[e.Divide=10]="Divide",e[e.Do=11]="Do",e[e.EndOfFile=12]="EndOfFile",e[e.EndOfFor=13]="EndOfFor",e[e.EndOfFunction=14]="EndOfFunction",e[e.EndOfIf=15]="EndOfIf",e[e.EndOfWhile=16]="EndOfWhile",e[e.EqualTo=17]="EqualTo",e[e.For=18]="For",e[e.From=19]="From",e[e.FunctionDeclaration=20]="FunctionDeclaration",e[e.GreaterThan=21]="GreaterThan",e[e.GreaterThanOrEqualTo=22]="GreaterThanOrEqualTo",e[e.If=23]="If",e[e.Increase=24]="Increase",e[e.LessThan=25]="LessThan",e[e.LessThanOrEqualTo=26]="LessThanOrEqualTo",e[e.Minus=27]="Minus",e[e.Modulo=28]="Modulo",e[e.Multiply=29]="Multiply",e[e.Mutable=30]="Mutable",e[e.Not=31]="Not",e[e.NotEqualTo=32]="NotEqualTo",e[e.Or=33]="Or",e[e.Otherwise=34]="Otherwise",e[e.Print=35]="Print",e[e.Return=36]="Return",e[e.Set=37]="Set",e[e.ThatReturn=38]="ThatReturn",e[e.ThenPutResultInto=39]="ThenPutResultInto",e[e.To=40]="To",e[e.ToBe=41]="ToBe",e[e.VariableDeclaration=42]="VariableDeclaration",e[e.InitializedTo=43]="InitializedTo",e[e.VariableTypeBoolean=44]="VariableTypeBoolean",e[e.VariableTypeNumber=45]="VariableTypeNumber",e[e.VariableTypeString=46]="VariableTypeString",e[e.While=47]="While",e[e.WithParam=48]="WithParam",e[e.WithArg=49]="WithArg"}(t||(t={}));var n,o=[{matcher:",",tokenType:t.Comma},{matcher:"plus",tokenType:t.Plus},{matcher:"and",tokenType:t.And},{matcher:"as",tokenType:t.As},{matcher:"boolean",tokenType:t.VariableTypeBoolean},{matcher:"but if",tokenType:t.ButIf},{matcher:"by",tokenType:t.By},{matcher:"call function",tokenType:t.FunctionCall},{matcher:"decrease",tokenType:t.Decrease},{matcher:"define function",tokenType:t.FunctionDeclaration},{matcher:"define variable",tokenType:t.VariableDeclaration},{matcher:"divide",tokenType:t.Divide},{matcher:"do",tokenType:t.Do},{matcher:"end of for",tokenType:t.EndOfFor},{matcher:"end of function",tokenType:t.EndOfFunction},{matcher:"end of if",tokenType:t.EndOfIf},{matcher:"end of while",tokenType:t.EndOfWhile},{matcher:"equal to",tokenType:t.EqualTo},{matcher:"false",tokenType:t.BooleanValueFalse},{matcher:"for",tokenType:t.For},{matcher:"from",tokenType:t.From},{matcher:"greater than or equal to",tokenType:t.GreaterThanOrEqualTo},{matcher:"greater than",tokenType:t.GreaterThan},{matcher:"if",tokenType:t.If},{matcher:"increase",tokenType:t.Increase},{matcher:"initialized to",tokenType:t.InitializedTo},{matcher:"less than or equal to",tokenType:t.LessThanOrEqualTo},{matcher:"less than",tokenType:t.LessThan},{matcher:"minus",tokenType:t.Minus},{matcher:"modulo",tokenType:t.Modulo},{matcher:"multiply",tokenType:t.Multiply},{matcher:"mutable",tokenType:t.Mutable},{matcher:"not equal to",tokenType:t.NotEqualTo},{matcher:"not",tokenType:t.Not},{matcher:"number",tokenType:t.VariableTypeNumber},{matcher:"or",tokenType:t.Or},{matcher:"otherwise",tokenType:t.Otherwise},{matcher:"return",tokenType:t.Return},{matcher:"print",tokenType:t.Print},{matcher:"set",tokenType:t.Set},{matcher:"string",tokenType:t.VariableTypeString},{matcher:"that return",tokenType:t.ThatReturn},{matcher:"then put result into",tokenType:t.ThenPutResultInto},{matcher:"to",tokenType:t.To},{matcher:"to be",tokenType:t.ToBe},{matcher:"true",tokenType:t.BooleanValueTrue},{matcher:"while",tokenType:t.While},{matcher:"with param",tokenType:t.WithParam},{matcher:"with arg",tokenType:t.WithArg}],i=function(){function e(){this.tokenStringSet=new Set}return e.prototype.addExpectedToken=function(e){this.tokenStringSet.add(e)},e.prototype.clear=function(){this.tokenStringSet.clear()},e.prototype.getExpectedTokenStringList=function(){var e=[];return this.tokenStringSet.forEach(function(t){return e.push(t)}),e.sort(),e},e}(),a=function(){function e(e,t){void 0===t&&(t=o),this.sourceCode=e,this.matchingRules=t,this.rulesMap=new Map,this.position=0,this.expectedErrorReportSet=new i;for(var n=0,a=t;n<a.length;n++){var s=a[n];this.rulesMap.set(s.tokenType,s.matcher)}this.lineMapper=new r(e)}return e.prototype.makeError=function(e,t){var r=this.lineMapper.getLineAndCol(e);return new Error("L"+r.line+":C"+r.col+"\n"+t)},e.prototype.isEndOfFile=function(e){return void 0===e&&(e=this.position),e>=this.sourceCode.length},e.prototype.getNextNonWhitespacePosition=function(e){for(void 0===e&&(e=this.position);!this.isEndOfFile(e)&&/\s/.test(this.sourceCode.charAt(e))===!0;)e++;return e},e.prototype.getNextWhitespacePosition=function(e){for(void 0===e&&(e=this.position);!this.isEndOfFile(e)&&/\s/.test(this.sourceCode.charAt(e))===!1;)e++;return e},e.prototype.checkForMatch=function(e){for(var t=this.getNextNonWhitespacePosition(this.position),r=0;r<e.length;r++)if(" "===e.charAt(r))t=this.getNextNonWhitespacePosition(t+1);else{if(this.isEndOfFile(t)||this.sourceCode.charAt(t).toLowerCase()!==e.charAt(r))return{isMatch:!1};t++}var n=this.getNextNonWhitespacePosition(t);return n!==t||this.isEndOfFile(n)?{isMatch:!0,newPosition:n}:{isMatch:!1}},e.prototype.getNextTokenType=function(e){for(var r=0,n=e;r<n.length;r++){var o=n[r];if(o===t.EndOfFile){var i=this.getNextNonWhitespacePosition();if(this.isEndOfFile(i))return this.expectedErrorReportSet.clear(),{token:o,nextPosition:i};this.expectedErrorReportSet.addExpectedToken("(EOF)")}else{var a=this.rulesMap.get(o),s=this.checkForMatch(a);if(s.isMatch===!0)return this.expectedErrorReportSet.clear(),{token:o,nextPosition:s.newPosition};this.expectedErrorReportSet.addExpectedToken(a)}}var c=this.expectedErrorReportSet.getExpectedTokenStringList().join(" | ");throw this.makeError(this.position,"Expected: "+c+".")},e.prototype.peekNextTokenType=function(e){try{return this.getNextTokenType(e).token}catch(e){return!1}},e.prototype.extractTokenType=function(e){var t=this.getNextTokenType(e);return this.position=t.nextPosition,t.token},e.prototype.getNextTokenAsString=function(){this.expectedErrorReportSet.clear();var e=this.getNextNonWhitespacePosition();if(this.isEndOfFile(e))throw this.makeError(e,"Unexpected EOF.");for(var t=this.getNextWhitespacePosition(e),r=this.sourceCode.slice(e,t),n=0,o=this.matchingRules;n<o.length;n++){var i=o[n],a=r.toLowerCase(),s=i.matcher;if(s===a||s.substr(0,r.length)===a&&s.length>r.length&&" "===s.charAt(r.length))throw this.makeError(e,'Unexpected reserved word "'+r+'".')}return{token:r,nextPosition:t}},e.prototype.extractNextTokenAsString=function(){var e=this.getNextTokenAsString();return this.position=e.nextPosition,e.token},e.prototype.peekNextTokenAsString=function(){try{return this.getNextTokenAsString().token}catch(e){return!1}},e.prototype.extractStringLiteralIfAny=function(){this.expectedErrorReportSet.clear();var e=this.getNextNonWhitespacePosition();if(this.isEndOfFile(e))return!1;var t=this.sourceCode.charAt(e);if("'"!==t&&'"'!==t&&"`"!==t)return!1;for(var r=e;;){if(r++,this.isEndOfFile(r))return!1;var n=this.sourceCode.charAt(r);if(n===t)return this.position=r+1,this.sourceCode.slice(e+1,r)}},e}();!function(e){e[e.Plus=0]="Plus",e[e.And=1]="And",e[e.Divide=2]="Divide",e[e.EqualTo=3]="EqualTo",e[e.GreaterThan=4]="GreaterThan",e[e.GreaterThanOrEqualTo=5]="GreaterThanOrEqualTo",e[e.LessThan=6]="LessThan",e[e.LessThanOrEqualTo=7]="LessThanOrEqualTo",e[e.Minus=8]="Minus",e[e.Modulo=9]="Modulo",e[e.Multiply=10]="Multiply",e[e.Not=11]="Not",e[e.NotEqualTo=12]="NotEqualTo",e[e.Or=13]="Or"}(n||(n={}));var s;!function(e){e[e.Number=0]="Number",e[e.String=1]="String",e[e.Boolean=2]="Boolean"}(s||(s={}));var c=[t.VariableDeclaration,t.Set,t.Increase,t.Decrease,t.Print,t.If,t.While,t.For,t.FunctionCall,t.Return],h=c.concat([t.FunctionDeclaration,t.EndOfFile]),p=[t.VariableTypeNumber,t.VariableTypeString,t.VariableTypeBoolean],u=[t.BooleanValueTrue,t.BooleanValueFalse],l=[t.Plus,t.And,t.Divide,t.EqualTo,t.GreaterThanOrEqualTo,t.GreaterThan,t.LessThanOrEqualTo,t.LessThan,t.Minus,t.Modulo,t.Multiply,t.NotEqualTo,t.Or],T=/^[a-zA-Z][a-zA-Z0-9-_]*$/,k=function(){function e(e){this.tokenizer=e}return e.parseSourceCode=function(t){var r=new a(t),n=new e(r);return n.parse()},e.prototype.createErrorInvalidToken=function(e,r){return void 0===r&&(r=""),new Error(("Invalid token "+t[e]+". "+r).trim())},e.prototype.parse=function(){for(var e={instructions:[]};;){var r=this.tokenizer.extractTokenType(h);if(r===t.FunctionDeclaration)e.instructions.push(this.createFunction());else{if(r===t.EndOfFile)break;e.instructions.push(this.createStatement(r))}}return e},e.prototype.createFunction=function(){var e=this.tokenizer.extractNextTokenAsString(),r=[];if(this.tokenizer.peekNextTokenType([t.WithParam])!==!1)for(this.tokenizer.extractTokenType([t.WithParam]);;){var n=this.tokenizer.extractNextTokenAsString();this.tokenizer.extractTokenType([t.As]);var o=this.createVariableTypeInfoIfAny();if(void 0===o)throw new Error('Parameter "'+n+'" of function "'+e+'" requires a valid type.');if(r.push({name:n,typeInfo:o}),this.tokenizer.peekNextTokenType([t.Comma])===!1)break;this.tokenizer.extractTokenType([t.Comma])}var i=void 0;this.tokenizer.peekNextTokenType([t.ThatReturn])!==!1&&(this.tokenizer.extractTokenType([t.ThatReturn]),i=this.createVariableType()),this.tokenizer.extractTokenType([t.Do]);var a=this.createStatements();return this.tokenizer.extractTokenType([t.EndOfFunction]),{type:"Function",functionName:e,parameters:r,returnType:i,statements:a}},e.prototype.createExpressionAtom=function(){var e=this.tokenizer.peekNextTokenType(u);if(e!==!1){this.tokenizer.extractTokenType(u);var r={type:"ExpressionAtom",atomType:"Boolean",value:e===t.BooleanValueTrue};return r}var n=this.tokenizer.extractStringLiteralIfAny();if(n!==!1){var r={type:"ExpressionAtom",atomType:"String",value:n};return r}var o=this.tokenizer.extractNextTokenAsString();if(/^-?([0-9]*\.[0-9]+|[0-9]+)$/.test(o)){var r={type:"ExpressionAtom",atomType:"Number",value:o};return r}if(T.test(o)){var r={type:"ExpressionAtom",atomType:"Variable",variableName:o};return r}throw new Error("Invalid expression.")},e.prototype.createExpression=function(){var e=this.tokenizer.peekNextTokenType([t.Not]);if(e!==!1){this.tokenizer.extractTokenType([t.Not]);var r={type:"Expression",operand:n.Not,rightValue:this.createExpression()};return r}var o=this.createExpressionAtom(),i=this.tokenizer.peekNextTokenType(l);if(i!==!1){var a=void 0;switch(i){case t.Plus:a=n.Plus;break;case t.And:a=n.And;break;case t.Divide:a=n.Divide;break;case t.EqualTo:a=n.EqualTo;break;case t.GreaterThan:a=n.GreaterThan;break;case t.GreaterThanOrEqualTo:a=n.GreaterThanOrEqualTo;break;case t.LessThan:a=n.LessThan;break;case t.LessThanOrEqualTo:a=n.LessThanOrEqualTo;break;case t.Minus:a=n.Minus;break;case t.Modulo:a=n.Modulo;break;case t.Multiply:a=n.Multiply;break;case t.NotEqualTo:a=n.NotEqualTo;break;case t.Or:a=n.Or;break;default:throw this.createErrorInvalidToken(i)}this.tokenizer.extractTokenType(l);var s={type:"Expression",leftValue:o,operator:a,rightValue:this.createExpression()};return s}return o},e.prototype.createVariableType=function(){var e,r=this.tokenizer.extractTokenType(p);if(r===t.VariableTypeNumber)e=s.Number;else if(r===t.VariableTypeString)e=s.String;else{if(r!==t.VariableTypeBoolean)throw this.createErrorInvalidToken(r);e=s.Boolean}return e},e.prototype.createVariableTypeInfoIfAny=function(){if(this.tokenizer.peekNextTokenType([t.Mutable]))return this.tokenizer.extractTokenType([t.Mutable]),{isMutable:!0,variableType:this.createVariableType()};try{var e=this.createVariableType();return{isMutable:!1,variableType:e}}catch(e){return}},e.prototype.createVariableDeclaration=function(){var e=this.tokenizer.extractNextTokenAsString();this.tokenizer.extractTokenType([t.ToBe]);var r=this.createVariableTypeInfoIfAny(),n=void 0,o=[t.EqualTo,t.InitializedTo];if(this.tokenizer.peekNextTokenType(o)!==!1&&(this.tokenizer.extractTokenType(o),n=this.createExpression()),void 0===r&&void 0===n)throw new Error("Variable declaration must either have a type or initial value.");return{type:"VariableDeclaration",variableName:e,variableTypeInfo:r,initialValue:n}},e.prototype.createAssignment=function(e){var r=this.tokenizer.extractNextTokenAsString();e===t.Set?this.tokenizer.extractTokenType([t.ToBe]):this.tokenizer.extractTokenType([t.By]);var n=this.createExpression();switch(e){case t.Set:var o={type:"AssignmentSet",variableName:r,value:n};return o;case t.Increase:var o={type:"AssignmentIncrease",variableName:r,value:n};return o;case t.Decrease:var o={type:"AssignmentDecrease",variableName:r,value:n};return o}throw this.createErrorInvalidToken(e)},e.prototype.createPrintStatement=function(){return{type:"PrintStatement",value:this.createExpression()}},e.prototype.createWhileLoop=function(){var e=this.createExpression();this.tokenizer.extractTokenType([t.Do]);var r=this.createStatements();return this.tokenizer.extractTokenType([t.EndOfWhile]),{type:"WhileBlock",condition:e,statements:r}},e.prototype.createForLoop=function(){var e=this.tokenizer.extractNextTokenAsString();this.tokenizer.extractTokenType([t.From]);var r=this.createExpression();this.tokenizer.extractTokenType([t.To]);var n=this.createExpression();this.tokenizer.extractTokenType([t.Do]);var o=this.createStatements();return this.tokenizer.extractTokenType([t.EndOfFor]),{type:"ForBlock",iteratorName:e,iteratorFrom:r,iteratorTo:n,statements:o}},e.prototype.createIfBlock=function(){var e=this.createExpression();this.tokenizer.extractTokenType([t.Do]);for(var r=this.createStatements(),n=[{condition:e,statements:r}],o=void 0;;){var i=this.tokenizer.peekNextTokenType([t.ButIf,t.Otherwise]);if(i!==t.ButIf){if(i===t.Otherwise){this.tokenizer.extractTokenType([t.Otherwise]),this.tokenizer.extractTokenType([t.Do]),o=this.createStatements();break}break}this.tokenizer.extractTokenType([t.ButIf]);var a=this.createExpression();this.tokenizer.extractTokenType([t.Do]);var s=this.createStatements();n.push({condition:a,statements:s})}return this.tokenizer.extractTokenType([t.EndOfIf]),{type:"IfBlock",ifBlocks:n,elseBlockStatements:o}},e.prototype.createFunctionCall=function(){var e=this.tokenizer.extractNextTokenAsString(),r=[];if(this.tokenizer.peekNextTokenType([t.WithArg])!==!1)for(this.tokenizer.extractTokenType([t.WithArg]);;){if(r.push(this.createExpression()),this.tokenizer.peekNextTokenType([t.Comma])===!1)break;this.tokenizer.extractTokenType([t.Comma])}var n=void 0;return this.tokenizer.peekNextTokenType([t.ThenPutResultInto])!==!1&&(this.tokenizer.extractTokenType([t.ThenPutResultInto]),n=this.tokenizer.extractNextTokenAsString()),{type:"FunctionCall",functionName:e,callArguments:r,resultTarget:n}},e.prototype.createReturnStatement=function(){return{type:"FunctionReturn",returnValue:this.createExpression()}},e.prototype.createStatements=function(){for(var e=[];;){var t=this.tokenizer.peekNextTokenType(c);if(t===!1)break;e.push(this.createStatement(this.tokenizer.extractTokenType(c)))}return e},e.prototype.createStatement=function(e){switch(e){case t.VariableDeclaration:return this.createVariableDeclaration();case t.Set:case t.Increase:case t.Decrease:return this.createAssignment(e);case t.Print:return this.createPrintStatement();case t.If:return this.createIfBlock();case t.While:return this.createWhileLoop();case t.For:return this.createForLoop();case t.FunctionCall:return this.createFunctionCall();case t.Return:return this.createReturnStatement()}throw this.createErrorInvalidToken(e)},e}();e.Parser=k,Object.defineProperty(e,"__esModule",{value:!0})});